<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üí∞ Cosmic Clicker</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="config.js"></script>
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
:root {
  --bg: #0a0a12; --surface: #13131d; --accent: #ffd700; --text: #ffffff;
  --muted: #5a5a6e; --success: #00ff88; --border: rgba(255,215,0,0.15);
}
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
body {
  font-family: 'Rajdhani', sans-serif; background: var(--bg); color: var(--text);
  min-height: 100vh; overflow-x: hidden;
}
body::before {
  content: ''; position: fixed; inset: 0;
  background: radial-gradient(circle at 20% 30%, rgba(255,215,0,0.15), transparent 40%);
  pointer-events: none; z-index: 0;
}
.app {
  position: relative; z-index: 1; max-width: 500px; margin: 0 auto; min-height: 100vh;
  padding: 1rem; padding-bottom: calc(100px + env(safe-area-inset-bottom));
}
.header { text-align: center; padding: 1.5rem 0; margin-bottom: 1rem; animation: slideUp 0.6s; }
.logo {
  font-family: 'Orbitron', sans-serif; font-size: 2rem; font-weight: 900;
  background: linear-gradient(135deg, #ffd700, #ffb800); -webkit-background-clip: text;
  -webkit-text-fill-color: transparent; animation: pulse 3s infinite;
}
.score-card {
  background: rgba(19,19,29,0.7); backdrop-filter: blur(20px); border: 2px solid var(--border);
  border-radius: 20px; padding: 2rem; margin-bottom: 2rem; text-align: center;
  animation: slideUp 0.6s 0.2s both;
}
.score-label { font-size: 0.8rem; color: var(--muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.score-display {
  font-family: 'Orbitron', sans-serif; font-size: 3rem; font-weight: 900;
  background: linear-gradient(135deg, #ffd700, #ffb800); -webkit-background-clip: text;
  -webkit-text-fill-color: transparent; margin: 0.5rem 0;
}
.per-click { font-size: 0.9rem; color: var(--muted); margin-top: 1rem; }
.per-click span { color: var(--success); font-weight: 700; font-family: 'Orbitron', sans-serif; }
.click-zone { display: flex; justify-content: center; margin: 2rem 0; padding: 1rem; animation: slideUp 0.6s 0.3s both; }
.click-target {
  width: 200px; height: 200px; border-radius: 50%;
  background: linear-gradient(145deg, #1a1a28, #13131d); border: 3px solid var(--accent);
  display: flex; align-items: center; justify-content: center; font-size: 5rem; cursor: pointer;
  transition: transform 0.2s; user-select: none; animation: float 3s infinite;
}
.click-target:active { transform: scale(0.95); }
.upgrades-title {
  font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 700; color: var(--accent);
  margin: 2rem 0 1rem 0; text-transform: uppercase; animation: slideUp 0.6s 0.4s both;
}
.upgrades { display: grid; gap: 0.75rem; animation: slideUp 0.6s 0.5s both; }
.upgrade {
  display: flex; justify-content: space-between; align-items: center; padding: 1.25rem;
  background: rgba(19,19,29,0.7); border: 1px solid var(--border); border-radius: 16px; transition: all 0.3s;
}
.upgrade:hover:not(.locked) {
  background: rgba(26,26,40,0.85); border-color: rgba(255,215,0,0.5); transform: translateX(4px);
}
.upgrade.locked { opacity: 0.4; cursor: not-allowed; }
.upgrade.unlocked { cursor: pointer; }
.upgrade-info h3 { font-size: 1rem; margin-bottom: 0.3rem; }
.upgrade-info p { font-size: 0.8rem; color: var(--muted); }
.upgrade-cost { font-family: 'Orbitron', sans-serif; font-weight: 700; color: var(--accent); font-size: 1.1rem; }
.panel { display: none; }
.panel.active { display: block; }
.nav-tabs {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; display: flex;
  background: rgba(19,19,29,0.95); backdrop-filter: blur(20px);
  padding: 0.5rem 0.5rem calc(0.5rem + env(safe-area-inset-bottom));
  border-top: 2px solid var(--border); box-shadow: 0 -8px 30px rgba(0,0,0,0.7);
}
.nav-tab {
  flex: 1; padding: 0.75rem 0.25rem; background: transparent; border: none; color: var(--muted);
  cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center;
  gap: 0.35rem; font-family: 'Orbitron', sans-serif; text-transform: uppercase;
  font-size: 0.65rem; font-weight: 700;
}
.nav-icon { font-size: 1.6rem; }
.nav-tab:hover { color: var(--text); background: rgba(255,215,0,0.1); }
.nav-tab.active { color: var(--accent); background: rgba(255,215,0,0.15); }
.nav-tab.active .nav-icon { transform: scale(1.1); filter: drop-shadow(0 0 8px rgba(255,215,0,0.6)); }
.stats-grid { display: grid; gap: 1rem; margin-top: 1rem; }
.stat-card {
  background: rgba(19,19,29,0.7); border: 1px solid var(--border); border-radius: 16px;
  padding: 1.5rem; display: flex; align-items: center; gap: 1.2rem; transition: all 0.3s;
}
.stat-card:hover { transform: translateY(-4px); border-color: rgba(255,215,0,0.3); }
.stat-icon { font-size: 2rem; }
.stat-info h3 {
  font-size: 0.8rem; color: var(--muted); margin-bottom: 0.3rem; text-transform: uppercase;
}
.stat-info p {
  font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 700;
  background: linear-gradient(135deg, #ffd700, #ffb800); -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.ranking-header {
  text-align: center; margin-bottom: 2rem; padding: 2rem; background: rgba(19,19,29,0.7);
  border: 2px solid var(--border); border-radius: 20px;
}
.ranking-header h2 {
  font-family: 'Orbitron', sans-serif; font-size: 2rem; margin-bottom: 0.5rem;
  background: linear-gradient(135deg, #ffd700, #ffb800); -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.ranking-list { display: flex; flex-direction: column; gap: 0.75rem; }
.rank-item {
  display: flex; align-items: center; gap: 1rem; padding: 1.25rem;
  background: rgba(19,19,29,0.7); border: 1px solid var(--border);
  border-radius: 16px; transition: all 0.3s;
}
.rank-item:hover { transform: translateX(6px); border-color: rgba(255,215,0,0.4); }
.rank-item.player { border: 2px solid var(--accent); box-shadow: 0 0 30px rgba(255,215,0,0.3); }
.rank-position {
  font-family: 'Orbitron', sans-serif; font-size: 1.3rem; font-weight: 900;
  background: linear-gradient(135deg, #ffd700, #ffb800); -webkit-background-clip: text;
  -webkit-text-fill-color: transparent; min-width: 50px; text-align: center;
}
.rank-info { flex: 1; }
.rank-name { font-weight: 600; margin-bottom: 0.2rem; }
.rank-power { font-size: 0.8rem; color: var(--muted); }
.rank-score {
  font-family: 'Orbitron', sans-serif; font-weight: 700; color: var(--accent); font-size: 1.2rem;
}
.ranking-loading { text-align: center; padding: 2rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo">üí∞ COSMIC CLICKER</div>
    </header>

    <div class="panel active" id="panel-game">
      <div class="score-card">
        <div class="score-label">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å</div>
        <div class="score-display" id="score">0</div>
        <div class="per-click">–ó–∞ —Ç–∞–ø: <span id="perClick">1</span> ü™ô</div>
      </div>
      <div class="click-zone">
        <div class="click-target" id="clickTarget">ü™ô</div>
      </div>
      <h3 class="upgrades-title">‚ö° –ú–∞–≥–∞–∑–∏–Ω —É–ª—É—á—à–µ–Ω–∏–π</h3>
      <div class="upgrades" id="upgrades"></div>
      <h3 class="upgrades-title">‚õèÔ∏è –ö—Ä–∏–ø—Ç–æ –º–∞–π–Ω–∏–Ω–≥ (–æ—Ñ—Ñ–ª–∞–π–Ω)</h3>
      <div class="score-card" style="margin-top:1rem;">
        <div class="score-label">–ú–∞–π–Ω–∏–Ω–≥ –≤ —á–∞—Å</div>
        <div class="score-display" style="font-size:1.5rem;" id="passiveIncome">0</div>
        <div class="per-click">‚è±Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç –¥–æ 3 —á–∞—Å–æ–≤ –æ—Ñ—Ñ–ª–∞–π–Ω</div>
      </div>
      <div class="upgrades" id="passiveUpgrades"></div>
    </div>

    <div class="panel" id="panel-friends">
      <div class="score-card">
        <div class="score-label">üéÅ –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –¥—Ä—É–≥–∞</div>
        <div class="score-display" style="font-size:1.8rem;">+5,000 ü™ô</div>
        <div class="per-click">+ 10% –æ—Ç –∑–∞—Ä–∞–±–æ—Ç–∫–∞</div>
      </div>
      <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="stat-card">
          <div><div class="stat-icon">üë•</div></div>
          <div class="stat-info"><h3>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</h3><p id="friendsCount">0</p></div>
        </div>
        <div class="stat-card">
          <div><div class="stat-icon">üí∞</div></div>
          <div class="stat-info"><h3>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</h3><p id="friendsReward">0</p></div>
        </div>
      </div>
      <button id="inviteBtn" style="width:100%;padding:1.25rem;background:linear-gradient(135deg,#ffd700,#ffb800);border:none;border-radius:16px;font-family:Orbitron;font-size:1rem;font-weight:900;color:#000;margin:1.5rem 0;cursor:pointer;">
        üì§ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞
      </button>
      <div style="padding:1rem;background:rgba(19,19,29,0.7);border-radius:16px;margin-bottom:1rem;">
        <div style="font-size:0.8rem;color:var(--muted);margin-bottom:0.5rem;">–¢–≤–æ—è —Å—Å—ã–ª–∫–∞:</div>
        <div style="display:flex;gap:0.5rem;">
          <input id="refLink" readonly style="flex:1;padding:0.75rem;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:0.8rem;font-family:monospace;" value="–ó–∞–≥—Ä—É–∑–∫–∞...">
          <button id="copyBtn" style="padding:0.75rem 1rem;background:rgba(255,215,0,0.2);border:1px solid var(--accent);border-radius:12px;cursor:pointer;font-size:1.2rem;">üìã</button>
        </div>
      </div>
      <h3 class="upgrades-title">–¢–≤–æ–∏ –¥—Ä—É–∑—å—è</h3>
      <div id="friendsList" class="ranking-list"></div>
    </div>

    <div class="panel" id="panel-shop">
      <div class="score-card">
        <div class="score-label">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥—ã –¥–ª—è @gamestoren_bot</div>
        <div class="score-display" style="font-size:1.5rem;">–°–∫–∏–¥–∫–∏</div>
        <div class="per-click">–ö—É–ø–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –ø–æ–ª—É—á–∏ —Å–∫–∏–¥–∫—É!</div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üéüÔ∏è</div>
          <div class="stat-info">
            <h3>–ö—É–ø–ª–µ–Ω–æ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</h3>
            <p id="promoCount">0</p>
          </div>
        </div>
      </div>
      
      <h3 class="upgrades-title">üí≥ –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã</h3>
      <div id="promocodesList"></div>
      
      <h3 class="upgrades-title" style="margin-top:2rem;">üé´ –ú–æ–∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã</h3>
      <div id="myPromocodes" class="ranking-list"></div>
    </div>

    <div class="panel" id="panel-stats">
      <h3 class="upgrades-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üëÜ</div>
          <div class="stat-info"><h3>–ö–ª–∏–∫–æ–≤</h3><p id="statClicks">0</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-info"><h3>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</h3><p id="statEarned">0</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üõçÔ∏è</div>
          <div class="stat-info"><h3>–ü–æ–∫—É–ø–æ–∫</h3><p id="statPurchases">0</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-info"><h3>–í—Ä–µ–º—è</h3><p id="statTime">0—Å</p></div>
        </div>
      </div>
    </div>

    <div class="panel" id="panel-ranking">
      <div class="ranking-header">
        <h2>üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í</h2>
        <p id="rankingSubtitle">–†–µ–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–∫–∏</p>
      </div>
      <div class="ranking-list" id="rankingList">
        <div class="ranking-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>

    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="game">
        <div class="nav-icon">üéÆ</div><div>–ò–≥—Ä–∞</div>
      </button>
      <button class="nav-tab" data-tab="shop">
        <div class="nav-icon">üéÅ</div><div>–°–∫–∏–¥–∫–∏</div>
      </button>
      <button class="nav-tab" data-tab="friends">
        <div class="nav-icon">üë•</div><div>–î—Ä—É–∑—å—è</div>
      </button>
      <button class="nav-tab" data-tab="stats">
        <div class="nav-icon">üìä</div><div>–°—Ç–∞—Ç—ã</div>
      </button>
      <button class="nav-tab" data-tab="ranking">
        <div class="nav-icon">üèÜ</div><div>–¢–æ–ø</div>
      </button>
    </nav>
  </div>

  <script>
const TgWebApp=window.Telegram?.WebApp;
const isTelegram=!!TgWebApp?.initDataUnsafe?.user;
const tgUser=isTelegram?TgWebApp.initDataUnsafe.user:null;
if(TgWebApp)TgWebApp.ready();

let db=null;
if(typeof firebase!=='undefined'&&typeof FIREBASE_ENABLED!=='undefined'&&FIREBASE_ENABLED&&typeof FIREBASE_CONFIG!=='undefined'){
  try{
    firebase.initializeApp(FIREBASE_CONFIG);
    db=firebase.firestore();
    console.log('‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω');
  }catch(e){
    console.warn('‚ö†Ô∏è Firebase error:',e);
  }
}

const state={
  score:BigInt(0),totalClicks:0,totalEarned:BigInt(0),totalSpent:BigInt(0),
  purchasesCount:0,startTime:Date.now(),lastOnline:Date.now(),
  referrals:[],referralRewards:0,
  purchasedPromocodes:[],
  upgrades:[
    {id:'bot',name:'ü§ñ –¢—Ä–µ–π–¥–∏–Ω–≥ –±–æ—Ç',desc:'+1 –∑–∞ —Ç–∞–ø',cost:10,value:1,count:0},
    {id:'exchange',name:'üí± –ö—Ä–∏–ø—Ç–æ–±–∏—Ä–∂–∞',desc:'+5 –∑–∞ —Ç–∞–ø',cost:100,value:5,count:0},
    {id:'blockchain',name:'‚õìÔ∏è –ë–ª–æ–∫—á–µ–π–Ω —É–∑–µ–ª',desc:'+25 –∑–∞ —Ç–∞–ø',cost:500,value:25,count:0},
    {id:'nft',name:'üé® NFT –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å',desc:'+100 –∑–∞ —Ç–∞–ø',cost:2500,value:100,count:0},
    {id:'defi',name:'üè¶ DeFi –ø—Ä–æ—Ç–æ–∫–æ–ª',desc:'+500 –∑–∞ —Ç–∞–ø',cost:10000,value:500,count:0},
    {id:'metaverse',name:'üåê –ú–µ—Ç–∞–≤—Å–µ–ª–µ–Ω–Ω–∞—è',desc:'+2500 –∑–∞ —Ç–∞–ø',cost:50000,value:2500,count:0},
  ],
  passiveUpgrades:[
    {id:'btc',name:'‚Çø Bitcoin –º–∞–π–Ω–µ—Ä',desc:'+10/—á–∞—Å',cost:500,value:10,count:0},
    {id:'eth',name:'Œû Ethereum —Ñ–µ—Ä–º–∞',desc:'+50/—á–∞—Å',cost:2500,value:50,count:0},
    {id:'asic',name:'‚öôÔ∏è ASIC —Ñ–µ—Ä–º–∞',desc:'+250/—á–∞—Å',cost:10000,value:250,count:0},
    {id:'pool',name:'üèä –ú–∞–π–Ω–∏–Ω–≥ –ø—É–ª',desc:'+1000/—á–∞—Å',cost:50000,value:1000,count:0},
    {id:'datacenter',name:'üè¢ –î–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä',desc:'+5000/—á–∞—Å',cost:250000,value:5000,count:0},
  ],
  promocodes:[
    {id:'promo10',name:'üéÅ –°–∫–∏–¥–∫–∞ 10%',desc:'–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ 10% –≤ @gamestoren_bot',cost:150000000,discount:10,purchased:false},
    {id:'promo20',name:'üéÅ –°–∫–∏–¥–∫–∞ 20%',desc:'–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ 20% –≤ @gamestoren_bot',cost:300000000,discount:20,purchased:false},
  ]
};

function formatNumber(n){
  const num=typeof n==='bigint'?Number(n):n;
  if(num>=1e9)return(num/1e9).toFixed(1)+'B';
  if(num>=1e6)return(num/1e6).toFixed(1)+'M';
  if(num>=1e3)return(num/1e3).toFixed(1)+'K';
  return Math.floor(num).toString();
}

function formatTime(ms){
  const s=Math.floor(ms/1000);
  const m=Math.floor(s/60);
  const h=Math.floor(m/60);
  if(h>0)return h+'—á '+(m%60)+'–º';
  if(m>0)return m+'–º';
  return s+'—Å';
}

function getUserId(){
  if(tgUser)return String(tgUser.id);
  let id=localStorage.getItem('local_id');
  if(!id){
    id='local_'+Date.now();
    localStorage.setItem('local_id',id);
  }
  return id;
}

function getDisplayName(){
  if(tgUser)return tgUser.first_name+(tgUser.last_name?' '+tgUser.last_name:'');
  return '–ì–æ—Å—Ç—å';
}

function getPerClick(){
  return 1+state.upgrades.reduce((sum,u)=>sum+u.value*u.count,0);
}

function getPassiveIncome(){
  return state.passiveUpgrades.reduce((sum,u)=>sum+u.value*u.count,0);
}

function calculateOfflineEarnings(){
  const now=Date.now();
  const hours=Math.min((now-state.lastOnline)/(1000*60*60),3);
  const earned=Math.floor(getPassiveIncome()*hours);
  state.lastOnline=now;
  return BigInt(earned);
}

function getReferralLink(){
  return `https://t.me/cosmicclicker_bot?start=ref_${getUserId()}`;
}

function checkReferral(){
  const startParam=TgWebApp?.initDataUnsafe?.start_param;
  console.log('üîç Start param:',startParam);
  if(startParam&&startParam.startsWith('ref_')){
    const refId=startParam.replace('ref_','');
    console.log('‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä:',refId);
    return refId;
  }
  return null;
}

async function processReferral(){
  const referrerId=checkReferral();
  console.log('üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞...');
  console.log('   –†–µ—Ñ–µ—Ä–µ—Ä ID:',referrerId);
  console.log('   DB –¥–æ—Å—Ç—É–ø–µ–Ω:',!!db);
  console.log('   Telegram user:',tgUser?tgUser.id:'–Ω–µ—Ç');
  
  if(!referrerId){
    console.log('‚ö†Ô∏è –ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏');
    return;
  }
  
  if(!db){
    console.log('‚ö†Ô∏è Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
    return;
  }
  
  if(!tgUser){
    console.log('‚ö†Ô∏è –ù–µ—Ç Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }
  
  const myId=getUserId();
  console.log('   –ú–æ–π ID:',myId);
  
  if(referrerId===myId){
    console.log('‚ö†Ô∏è –ù–µ–ª—å–∑—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è');
    return;
  }
  
  try{
    console.log('üì• –ü—Ä–æ–≤–µ—Ä—è—é –±—ã–ª –ª–∏ —É–∂–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω...');
    const myDoc=await db.collection('players').doc(myId).get();
    if(myDoc.exists&&myDoc.data().referredBy){
      console.log('‚ö†Ô∏è –£–∂–µ –±—ã–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω —Ä–∞–Ω–µ–µ:',myDoc.data().referredBy);
      return;
    }
    
    console.log('üì• –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞...');
    const refDoc=await db.collection('players').doc(referrerId).get();
    if(!refDoc.exists){
      console.log('‚ö†Ô∏è –†–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ');
      // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      await db.collection('players').doc(referrerId).set({
        referrals:[{
          id:myId,
          name:getDisplayName(),
          joinedAt:Date.now()
        }],
        referralRewards:5000,
        score:5000,
        updatedAt:Date.now()
      },{merge:true});
      console.log('‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ —Å –Ω–∞–≥—Ä–∞–¥–æ–π!');
    }else{
      const refData=refDoc.data();
      console.log('üìä –î–∞–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞:',{
        name:refData.name,
        currentScore:refData.score,
        currentReferrals:(refData.referrals||[]).length
      });
      
      const newReferrals=[...(refData.referrals||[]),{
        id:myId,
        name:getDisplayName(),
        joinedAt:Date.now()
      }];
      
      const newScore=Number(refData.score||0)+5000;
      const newRewards=(refData.referralRewards||0)+5000;
      
      console.log('üíæ –û–±–Ω–æ–≤–ª—è—é —Ä–µ—Ñ–µ—Ä–µ—Ä–∞...');
      console.log('   –ù–æ–≤—ã–π —Å—á—ë—Ç:',newScore);
      console.log('   –í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:',newReferrals.length);
      
      await db.collection('players').doc(referrerId).update({
        referrals:newReferrals,
        referralRewards:newRewards,
        score:newScore,
        updatedAt:Date.now()
      });
      
      console.log('‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!');
    }
    
    console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é –∫—Ç–æ –º–µ–Ω—è –ø—Ä–∏–≥–ª–∞—Å–∏–ª...');
    await db.collection('players').doc(myId).set({
      referredBy:referrerId,
      name:getDisplayName(),
      username:tgUser?.username||'',
      joinedAt:Date.now(),
      updatedAt:Date.now()
    },{merge:true});
    
    console.log('üéâ –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –ù–ê–ì–†–ê–î–ê –ù–ê–ß–ò–°–õ–ï–ù–ê!');
    console.log(`üí∞ –†–µ—Ñ–µ—Ä–µ—Ä ${referrerId} –ø–æ–ª—É—á–∏–ª +5,000 –º–æ–Ω–µ—Ç`);
    
    if(TgWebApp?.showPopup){
      TgWebApp.showPopup({
        title:'üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
        message:'–¢—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ!\n\n–¢–≤–æ–π –¥—Ä—É–≥ –ø–æ–ª—É—á–∏–ª +5,000 ü™ô',
        buttons:[{type:'ok'}]
      });
    }
  }catch(e){
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞:',e);
    console.error('   –î–µ—Ç–∞–ª–∏:',e.message);
  }
}

async function saveToFirebase(){
  if(!db)return;
  try{
    await db.collection('players').doc(getUserId()).set({
      name:getDisplayName(),
      username:tgUser?.username||'',
      score:Number(state.score),
      perClick:getPerClick(),
      passiveIncome:getPassiveIncome(),
      totalClicks:state.totalClicks,
      referrals:state.referrals,
      referralRewards:state.referralRewards,
      lastOnline:state.lastOnline,
      purchasedPromocodes:state.purchasedPromocodes,
      upgrades:state.upgrades.map(u=>({count:u.count})),
      passiveUpgrades:state.passiveUpgrades.map(u=>({count:u.count})),
      updatedAt:Date.now()
    },{merge:true});
  }catch(e){
    console.error('Save error:',e);
  }
}

async function loadFromFirebase(){
  if(!db||!tgUser)return;
  try{
    const doc=await db.collection('players').doc(getUserId()).get();
    if(doc.exists){
      const d=doc.data();
      state.score=BigInt(d.score||0);
      state.totalClicks=d.totalClicks||0;
      state.lastOnline=d.lastOnline||Date.now();
      state.referrals=d.referrals||[];
      state.referralRewards=d.referralRewards||0;
      state.purchasedPromocodes=d.purchasedPromocodes||[];
      if(d.upgrades){
        d.upgrades.forEach((u,i)=>{
          if(state.upgrades[i])state.upgrades[i].count=u.count||0;
        });
      }
      if(d.passiveUpgrades){
        d.passiveUpgrades.forEach((u,i)=>{
          if(state.passiveUpgrades[i])state.passiveUpgrades[i].count=u.count||0;
        });
      }
    }
  }catch(e){
    console.error('Load error:',e);
  }
}

function render(){
  const perClick=getPerClick();
  const passiveIncome=getPassiveIncome();
  
  document.getElementById('score').textContent=formatNumber(state.score);
  document.getElementById('perClick').textContent=formatNumber(perClick);
  document.getElementById('passiveIncome').textContent=formatNumber(passiveIncome)+' ü™ô';
  
  document.getElementById('upgrades').innerHTML=state.upgrades.map((u,i)=>{
    const cost=Math.floor(u.cost*Math.pow(1.15,u.count));
    const locked=state.score<BigInt(cost);
    return `
      <div class="upgrade ${locked?'locked':'unlocked'}" data-index="${i}">
        <div class="upgrade-info">
          <h3>${u.name}</h3>
          <p>${u.desc}${u.count>0?' ¬∑ x'+u.count:''}</p>
        </div>
        <div class="upgrade-cost">${formatNumber(cost)} ü™ô</div>
      </div>
    `;
  }).join('');
  
  document.querySelectorAll('#upgrades .upgrade.unlocked').forEach(el=>{
    el.addEventListener('click',()=>buyUpgrade(parseInt(el.dataset.index)));
  });
  
  document.getElementById('passiveUpgrades').innerHTML=state.passiveUpgrades.map((u,i)=>{
    const cost=Math.floor(u.cost*Math.pow(1.15,u.count));
    const locked=state.score<BigInt(cost);
    return `
      <div class="upgrade ${locked?'locked':'unlocked'}" data-index="${i}" data-type="passive">
        <div class="upgrade-info">
          <h3>${u.name}</h3>
          <p>${u.desc}${u.count>0?' ¬∑ x'+u.count:''}</p>
        </div>
        <div class="upgrade-cost">${formatNumber(cost)} ü™ô</div>
      </div>
    `;
  }).join('');
  
  document.querySelectorAll('#passiveUpgrades .upgrade.unlocked').forEach(el=>{
    el.addEventListener('click',()=>buyPassiveUpgrade(parseInt(el.dataset.index)));
  });
  
  document.getElementById('statClicks').textContent=formatNumber(state.totalClicks);
  document.getElementById('statEarned').textContent=formatNumber(state.totalEarned+state.totalSpent);
  document.getElementById('statPurchases').textContent=state.purchasesCount;
  document.getElementById('statTime').textContent=formatTime(Date.now()-state.startTime);
  
  document.getElementById('friendsCount').textContent=state.referrals.length;
  document.getElementById('friendsReward').textContent=formatNumber(state.referralRewards);
  
  const friendsList=document.getElementById('friendsList');
  if(state.referrals.length===0){
    friendsList.innerHTML='<div class="ranking-loading">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç üë•</div>';
  }else{
    friendsList.innerHTML=state.referrals.map(f=>`
      <div class="rank-item">
        <div class="rank-position">üë§</div>
        <div class="rank-info">
          <div class="rank-name">${f.name}</div>
          <div class="rank-power">+5,000 ü™ô</div>
        </div>
      </div>
    `).join('');
  }
  
  // –ü—Ä–æ–º–æ–∫–æ–¥—ã
  renderPromocodes();
  
  saveToFirebase();
}

function generatePromocode(discount){
  const prefix='COSMIC';
  const random=Math.random().toString(36).substring(2,8).toUpperCase();
  return `${prefix}${discount}_${random}`;
}

function renderPromocodes(){
  const promoList=document.getElementById('promocodesList');
  const myPromos=document.getElementById('myPromocodes');
  const promoCount=document.getElementById('promoCount');
  
  if(!promoList||!myPromos||!promoCount)return;
  
  promoCount.textContent=state.purchasedPromocodes.length;
  
  promoList.innerHTML=state.promocodes.map((p,i)=>{
    const purchased=state.purchasedPromocodes.some(pp=>pp.id===p.id);
    const locked=state.score<BigInt(p.cost)||purchased;
    return `
      <div class="upgrade ${locked?'locked':'unlocked'}" data-index="${i}" data-type="promo">
        <div class="upgrade-info">
          <h3>${p.name}</h3>
          <p>${p.desc}${purchased?' ¬∑ ‚úÖ –ö—É–ø–ª–µ–Ω–æ':''}</p>
        </div>
        <div class="upgrade-cost">${formatNumber(p.cost)} ü™ô</div>
      </div>
    `;
  }).join('');
  
  document.querySelectorAll('[data-type="promo"].upgrade.unlocked').forEach(el=>{
    el.addEventListener('click',()=>buyPromocode(parseInt(el.dataset.index)));
  });
  
  if(state.purchasedPromocodes.length===0){
    myPromos.innerHTML='<div class="ranking-loading">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ üé´</div>';
  }else{
    myPromos.innerHTML=state.purchasedPromocodes.map(p=>`
      <div class="rank-item">
        <div class="rank-position">${p.discount}%</div>
        <div class="rank-info">
          <div class="rank-name">${p.name}</div>
          <div class="rank-power" style="font-family:monospace;font-size:0.9rem;">${p.code}</div>
        </div>
        <button onclick="copyPromo('${p.code}')" style="padding:0.5rem 1rem;background:rgba(255,215,0,0.2);border:1px solid var(--accent);border-radius:8px;cursor:pointer;font-size:0.9rem;">üìã</button>
      </div>
    `).join('');
  }
}

function copyPromo(code){
  navigator.clipboard.writeText(code).then(()=>{
    if(TgWebApp?.showPopup){
      TgWebApp.showPopup({
        title:'‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!',
        message:`–ü—Ä–æ–º–æ–∫–æ–¥ ${code} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\n\n–ò—Å–ø–æ–ª—å–∑—É–π –≤ @gamestoren_bot`,
        buttons:[{type:'ok'}]
      });
    }
  });
}

function buyPromocode(index){
  const p=state.promocodes[index];
  const cost=BigInt(p.cost);
  
  if(state.purchasedPromocodes.some(pp=>pp.id===p.id)){
    console.log('‚ö†Ô∏è –ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∫—É–ø–ª–µ–Ω');
    return;
  }
  
  if(state.score>=cost){
    const code=generatePromocode(p.discount);
    
    state.score-=cost;
    state.totalSpent+=cost;
    state.purchasesCount++;
    state.purchasedPromocodes.push({
      id:p.id,
      name:p.name,
      code:code,
      discount:p.discount,
      purchasedAt:Date.now()
    });
    
    console.log(`‚úÖ –ö—É–ø–ª–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥: ${code} (${p.discount}%)`);
    
    if(TgWebApp?.showPopup){
      TgWebApp.showPopup({
        title:'üéâ –ü—Ä–æ–º–æ–∫–æ–¥ –∫—É–ø–ª–µ–Ω!',
        message:`${p.name}\n–ö–æ–¥: ${code}\n\n–ò—Å–ø–æ–ª—å–∑—É–π –≤ @gamestoren_bot –¥–ª—è —Å–∫–∏–¥–∫–∏ ${p.discount}%!`,
        buttons:[{type:'ok'}]
      });
    }
    
    render();
  }else{
    console.log('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
  }
}

async function renderRanking(){
  const list=document.getElementById('rankingList');
  console.log('üèÜ –ó–∞–≥—Ä—É–∂–∞—é —Ä–µ–π—Ç–∏–Ω–≥...');
  
  if(!db){
    console.log('‚ö†Ô∏è Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    list.innerHTML='<div class="ranking-loading">‚ö†Ô∏è Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</div>';
    return;
  }
  
  list.innerHTML='<div class="ranking-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>';
  
  try{
    console.log('üì• –ó–∞–ø—Ä–æ—Å –∫ Firebase...');
    const snapshot=await db.collection('players').orderBy('score','desc').limit(100).get();
    console.log('üìä –ü–æ–ª—É—á–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:',snapshot.size);
    
    const players=[];
    snapshot.forEach(doc=>{
      const d=doc.data();
      console.log('   –ò–≥—Ä–æ–∫:',doc.id,d.name,d.score);
      players.push({
        id:doc.id,
        name:d.name||'–ò–≥—Ä–æ–∫',
        username:d.username,
        score:d.score||0,
        perClick:d.perClick||0,
        isMe:doc.id===getUserId()
      });
    });
    
    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏–≥—Ä–æ–∫–æ–≤:',players.length);
    
    if(players.length===0){
      console.log('‚ö†Ô∏è –ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ');
      list.innerHTML='<div class="ranking-loading">üéÆ –ë—É–¥—å –ø–µ—Ä–≤—ã–º –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!</div>';
    }else{
      document.getElementById('rankingSubtitle').textContent=`–¢–æ–ø-${players.length} –∏–≥—Ä–æ–∫–æ–≤`;
      list.innerHTML=players.map((p,i)=>`
        <div class="rank-item ${p.isMe?'player':''}">
          <div class="rank-position">${i+1}${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':''}</div>
          <div class="rank-info">
            <div class="rank-name">${p.name}${p.username?' @'+p.username:''}</div>
            <div class="rank-power">‚ö° ${formatNumber(p.perClick)}/—Ç–∞–ø</div>
          </div>
          <div class="rank-score">${formatNumber(p.score)}</div>
        </div>
      `).join('');
      console.log('‚úÖ –†–µ–π—Ç–∏–Ω–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω!');
    }
  }catch(e){
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:',e);
    console.error('   –î–µ—Ç–∞–ª–∏:',e.message);
    
    if(e.code==='permission-denied'){
      list.innerHTML=`
        <div class="ranking-loading">
          üîí –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Firestore<br>
          <small style="font-size:0.8rem;margin-top:0.5rem;display:block;">
            –ù–∞—Å—Ç—Ä–æ–π –ø—Ä–∞–≤–∏–ª–∞ –≤ Firebase Console:<br>
            Firestore ‚Üí Rules ‚Üí allow read: if true;
          </small>
        </div>
      `;
    }else{
      list.innerHTML='<div class="ranking-loading">‚ùå –û—à–∏–±–∫–∞: '+e.message+'</div>';
    }
  }
}

function buyUpgrade(index){
  const u=state.upgrades[index];
  const cost=BigInt(Math.floor(u.cost*Math.pow(1.15,u.count)));
  if(state.score>=cost){
    state.score-=cost;
    state.totalSpent+=cost;
    state.purchasesCount++;
    u.count++;
    render();
  }
}

function buyPassiveUpgrade(index){
  const u=state.passiveUpgrades[index];
  const cost=BigInt(Math.floor(u.cost*Math.pow(1.15,u.count)));
  if(state.score>=cost){
    state.score-=cost;
    state.totalSpent+=cost;
    state.purchasesCount++;
    u.count++;
    render();
  }
}

document.querySelectorAll('.nav-tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('panel-'+tab.dataset.tab).classList.add('active');
    if(tab.dataset.tab==='ranking')renderRanking();
  });
});

document.getElementById('clickTarget').addEventListener('click',()=>{
  const gain=BigInt(getPerClick());
  state.score+=gain;
  state.totalEarned+=gain;
  state.totalClicks++;
  render();
});

document.getElementById('refLink').value=getReferralLink();

document.getElementById('copyBtn').addEventListener('click',async()=>{
  const link=document.getElementById('refLink').value;
  try{
    await navigator.clipboard.writeText(link);
    document.getElementById('copyBtn').textContent='‚úÖ';
    setTimeout(()=>document.getElementById('copyBtn').textContent='üìã',2000);
  }catch(e){
    console.error('Copy error:',e);
  }
});

document.getElementById('inviteBtn').addEventListener('click',()=>{
  if(!isTelegram)return;
  const link=getReferralLink();
  const msg=`üéÆ –ò–≥—Ä–∞–π –≤ Cosmic Clicker!\nüí∞ –¢–∞–ø–∞–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π\nüéÅ –ë–æ–Ω—É—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!`;
  TgWebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(msg)}`);
});

(async()=>{
  console.log('üöÄ –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
  console.log('   Telegram:',isTelegram);
  console.log('   User:',tgUser?tgUser.id:'–Ω–µ—Ç');
  console.log('   Firebase:',!!db);
  
  if(db&&tgUser){
    console.log('üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞...');
    await processReferral();
    
    console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase...');
    await loadFromFirebase();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä–æ–∫–∞ –≤ —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    console.log('üíæ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ...');
    await saveToFirebase();
  }
  
  console.log('‚è∞ –†–∞—Å—á—ë—Ç –æ—Ñ—Ñ–ª–∞–π–Ω –∑–∞—Ä–∞–±–æ—Ç–∫–∞...');
  const offlineEarnings=calculateOfflineEarnings();
  if(offlineEarnings>0){
    console.log(`üí∞ –û—Ñ—Ñ–ª–∞–π–Ω –∑–∞—Ä–∞–±–æ—Ç–æ–∫: +${formatNumber(offlineEarnings)}`);
    state.score+=offlineEarnings;
    state.totalEarned+=offlineEarnings;
    
    if(TgWebApp?.showPopup){
      const hours=Math.min((Date.now()-state.lastOnline)/(1000*60*60),3);
      TgWebApp.showPopup({
        title:'üí§ –ú–∞–π–Ω–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–ª!',
        message:`–¢—ã –±—ã–ª –æ—Ñ—Ñ–ª–∞–π–Ω ${hours.toFixed(1)} —á\n\n–ù–∞–º–∞–π–Ω–µ–Ω–æ: +${formatNumber(offlineEarnings)} ü™ô`,
        buttons:[{type:'ok'}]
      });
    }
  }
  
  console.log('üé® –†–µ–Ω–¥–µ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...');
  render();
  console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
})();
  </script>
</body>
</html>
